#!/bin/bash
# MCP Status - Check MCP server configuration status for Claude Code
# Follows microdot precedence: local overrides public, both are optional

CLAUDE_CODE_CONFIG="$HOME/.claude.json"
ZSH="${ZSH:-$HOME/.dotfiles}"

echo "=== MCP Server Status for Claude Code ==="
echo

# Find servers.json following precedence (local wins if both exist)
MCP_CONFIG=""
if [[ -f "$ZSH/.local/claude/mcp/servers.json" ]]; then
    MCP_CONFIG="$ZSH/.local/claude/mcp/servers.json"
    CONFIG_LOCATION="local"
elif [[ -f "$ZSH/claude/mcp/servers.json" ]]; then
    MCP_CONFIG="$ZSH/claude/mcp/servers.json"
    CONFIG_LOCATION="public"
else
    CONFIG_LOCATION="none"
fi

# Check Claude Code config
if [ -f "$CLAUDE_CODE_CONFIG" ]; then
    echo " Claude Code configuration found at:"
    echo "   $CLAUDE_CODE_CONFIG"
    echo
    
    if command -v jq >/dev/null 2>&1; then
        # Check if MCP servers are configured
        if jq -e '.mcpServers' "$CLAUDE_CODE_CONFIG" >/dev/null 2>&1; then
            echo "Configured MCP servers:"
            jq -r '.mcpServers | to_entries[] | "  - \(.key)"' "$CLAUDE_CODE_CONFIG" 2>/dev/null || echo "  Unable to parse configuration"
        else
            echo "L No MCP servers configured in Claude Code"
            echo "   Run 'mcp-setup' to configure MCP servers"
        fi
    else
        echo "  (install jq to see server details)"
    fi
else
    echo "L Claude Code configuration not found"
    echo "   Run 'mcp-setup' to create configuration"
fi

echo
echo "MCP configuration source:"
if [[ "$CONFIG_LOCATION" == "local" ]]; then
    echo "   Using LOCAL: $MCP_CONFIG"
    if command -v jq >/dev/null 2>&1; then
        echo "  Available servers:"
        jq -r '.mcpServers | to_entries[] | "    - \(.key)"' "$MCP_CONFIG" 2>/dev/null || echo "    Unable to parse configuration"
    fi
elif [[ "$CONFIG_LOCATION" == "public" ]]; then
    echo "   Using PUBLIC: $MCP_CONFIG"
    if command -v jq >/dev/null 2>&1; then
        echo "  Available servers:"
        jq -r '.mcpServers | to_entries[] | "    - \(.key)"' "$MCP_CONFIG" 2>/dev/null || echo "    Unable to parse configuration"
    fi
else
    echo "  ï¿½  No servers.json found in local or public"
    echo "     Checked: $ZSH/.local/claude/mcp/"
    echo "     Checked: $ZSH/claude/mcp/"
fi

echo
echo "Claude Code location:"
if [ -d "/Applications/Claude Code.app" ]; then
    echo "   /Applications/Claude Code.app"
elif command -v claude >/dev/null 2>&1; then
    echo "   Claude Code CLI found: $(which claude)"
else
    echo "  ï¿½  Claude Code app not found in /Applications"
fi
